# 多联供-内机

## 仓库目录

```Markdown
├── .gitlab      // 模板文件夹
├── Code         // 源码文件夹
├── Docs         // 文档文件夹
├── MDK_ARM      // Keil编译文件夹
├── Tool         // 工具文件夹
├── xxx.bat      // 各种批处理
├── Chip&PJ.rar  // Keil工程文件、SI工程文件等
└── README.md    // 说明文档
```

## 关于议题

- 若有此项目新发现的问题反馈或优化事项，必需通过 **新建议题** 进行记录&跟踪
- 新建议题时，请选择合适的议题模板进行信息完善，其中包括：

  - **问题BUG**：针对厂家客户反馈的各种问题及BUG记录
  - **外部需求**：针对厂家客户提出的新增功能、全新逻辑，或对现有功能逻辑提出的修改、调整等
  - **内部优化**：针对PUNP内部发现的问题、提出的新增功能、全新逻辑、逻辑变更、各种优化项、改进项等
  - **参数固化**：仅针对厂家客户提出的机型参数固化需求
  - **交叉测试**：针对议题进行的软件交叉测试
  - **内部测试**：针对PUNP内部发起的软件测试任务
  - **版本升级**：针对内部临时/正式版本升级、外部临时/正式版本升级

## 分支说明

- `main` 分支：**开发分支**
  - 后续进行更改前，请基于 `main` 分支创建新分支
  - 新建合并请求时，`main` 分支默认作为目标分支
- `test-*` 分支：**内部测试分支**
  - 执行内部测试前创建的分支，此分支上的版本可提供测试工程师
  - `test-*` 分支的上游分支为 `main` 分支
  - `test-*` 分支仅针对已有功能上的问题BUG修复，原则上不增加新功能
- `release` 分支：**发布分支**
  - 用于发布已通过内部测试的 **内部版本**
  - `release` 分支的上游分支为 `test-*` 分支
  - `release` 分支上的版本，可选择用于合并至 `prod-*` 分支上进行转正
- `prod-*` 分支：**客户生产分支**
  - 用于发布不同编译目标下的 **正式版本**，此分支上的版本可提供产线
  - `prod-*` 分支的上游分支为 `release` 分支
- `production` 分支：**共用生产分支**（**已废弃，后续不会合并新的提交**）

## 使用指引

### 克隆仓库

1. 点击仓库右上方 **“克隆”** 按钮，复制 **“使用 HTTP 克隆”** 一栏中的仓库URL地址
2. 在本地对应微码文件夹中（注意：请放在与所有版本同级的路径下），在空白处单击 **鼠标右键** --> 选择 **"Git 克隆..."**，或使用命令行等方式，将模块源码拉取至本地项目文件夹中
3. 克隆完成后，请检查 `x1-hl080a-k05-001` 文件夹是否成功拉取

### 初始化仓库

1. 进入 `x1-hl080a-k05-001` 文件夹
2. 双击 `01初始化工程.bat`，完成提交模板配置、SI工程初始化、Keil工程初始化等操作
3. 双击 `01初始化子模块.bat`，初始化仓库内使用到的子模块

> - **注意事项**
> - 运行 `01初始化工程.bat` 后，若遇到解压过程中报错，请检查当前本仓库的SI工程或Keil工程是否已经手动打开，如已打开，请将本仓库的SI工程和Keil工程手动关闭后重试
> - 切换至不同分支或标签时，由于Keil工程/子模块可能发生改变，导致编译环境不同，请注意重新运行 `01初始化工程.bat` 和 `01初始化子模块.bat`
> - 切换至不同分支或标签时，如遇到因子模块问题而无法切换时，请手动删除子模块中的内容后再尝试

### 打开工程

1. 进入 `x1-hl080a-k05-001` 文件夹
2. 双击 `02打开工程.bat`，同时打开SI工程和Keil工程

## 条件编译目标

| 编译目标   | 目标宏定义(KEIL) | 微码(初始)            | 微码(正式)            |
| ---------- | ---------------- | --------------------- | --------------------- |
| 内部调试   | `DEBUG`          | `X1.HL080A.K05.001-0` | `X1.HL080A.K05.001-0` |
| 中山TCL    | `TCL`            | `X1.HL080A.K05.001-1` | `X1.HL080A.K05.001-1` |
| 中山长虹   | `CHANGHONG`      | `X1.HL080A.K05.001-2` | `X1.HL080A.K05.501-1` |
| 通用       | `TONGYONG`       | `X1.HL080A.K05.001-3` | `X1.HL087A.K05.001-1` |
| 广州迪森   | `DISEN`          | `X1.HL080A.K05.001-4` | `X1.HL087A.K05.502-1` |
| 广东派沃   | `PAIWO`          | `X1.HL080A.K05.001-5` | `X1.HL087A.K05.501-1` |
| 广东纽恩泰 | `NIUENTAI`       | `X1.HL087A.K05.503-1` | `X1.HL087A.K05.503-1` |
| 浙江生能   | `SHENGNENG`      | `X1.HL087A.K05.504-1` | `X1.HL087A.K05.504-1` |
| 佛山鸿禾   | `HONGHE`         | `X1.HL087A.K05.505-1` | `X1.HL087A.K05.505-1` |
| 万和集团   | `WANHE`          | `X1.HL087A.K05.506-1` | `X1.HL087A.K05.506-1` |
| 广东长帆   | `CHANGFAN`       | `X1.HL087A.K05.507-1` | `X1.HL087A.K05.507-1` |

> 注：目前微码中的硬件型号（HL080A/HL087A）与硬件实物对应

## 条件编译功能

### 长期开放功能

- 用于疑难杂症的长期监控&追踪

| 功能目标               | 功能宏定义            | 说明                                   |
| ---------------------- | --------------------- | -------------------------------------- |
| 使用BMS读FLASH、EEPROM | `USE_SPECIAL_READ`    | 可通过BMS读取FLASH、EEPROM中的完整内容 |
| 使用BMS调试            | `USE_BMS_DEBUG`       | 可通过BMS查看&修改某些调试变量信息     |
| 使用BMS读通讯测试信息  | `USE_COMMU_TEST_READ` | 可通过BMS读取通讯测试信息              |

### 对外可开放功能

- **注意**：以下功能可有选择性地开放给厂家客户
- 如需给某个 **条件编译目标** 开放新功能，请添加相应的 **功能宏定义** 语句：`#define USE_XXX`

| 功能目标                  | 功能宏定义       | 说明                                                                                                                                           | 备注                                                         |
| ------------------------- | ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| 使用拨码设置机型&机型校验 | `USE_SW_MAC`     | 禁用：通过参数【**机器型号**】 设置机型，且无机型校验<br/>使用：通过 **拨码(SW4.3+SW4.4+SW5)** 设置机型，且具备机型校验                        | 无                                                           |
| 使用旧工况频率表          | `USE_WF_OLD`     | 使用：采用旧三段水温工况频率表<br/>禁用：采用新四段水温工况频率表                                                                              | 无                                                           |
| 使用HL081B外机板          | `USE_ODU_HL081B` | 禁用：使用HL081A外机板<br/>使用：使用HL081B外机板                                                                                              | **此功能宏定义与温度探头配置、压力传感器配置中的可选项有关** |
| 使用R290工况频率表        | `USE_WF_R290`    | 禁用：不使用R290工况频率表<br/>使用：使用R290工况频率表                                                                                        | 禁用 `USE_WF_OLD` 时，`USE_WF_R290` 固定为使用               |
| 使用B区固定范围           | `USE_AREA_B_FIX` | 禁用：B区设定温度范围根据当前控制对象动态调整（与A区设定温度范围处理一致）<br/>使用：B区设定温度范围为固定值                                   | 无                                                           |
| 使用新制热环温分段        | `USE_HT_ENV_NEW` | 禁用：使用旧制热环温分段<br/>使用：使用新制热环温分段                                                                                          | 无                                                           |
| 使用能力测试固定目标温度  | `USE_AT_SV_FIX`  | 禁用：制冷/制热能力测试目标水温分别使用参数【**制冷设定温度**】、【**制热设定温度**】<br/>使用：制冷/制热能力测试目标水温分别使用固定值5℃、62℃ | 无                                                           |
| 使用能力测试辅阀控制      | `USE_AT_EEVS`    | 禁用：无能力测试辅阀控制<br/>使用：有能力测试辅阀控制                                                                                          | 无                                                           |

### 仅内部调试功能

- **特别强调！！！** 以下功能仅供特殊操作使用，不可开放给任何厂家客户

| 功能目标                    | 功能宏定义                | 说明                                                                                  | 备注                                         |
| --------------------------- | ------------------------- | ------------------------------------------------------------------------------------- | -------------------------------------------- |
| 使用多机型参数套件          | `USE_KIT_PARA_FAC`        | 禁用：有正常BMS功能<br/>使用：无正常BMS功能，允许 **参数管理助手** 自动读取机型参数   | 所有编译目标需要单独开启                     |
| 使用快速时间                | `USE_QUICK_TIME`          | 禁用：使用正常默认时间<br/>使用：使用快速时间代替正常默认时间，减少测试等待           | `DEBUG` 固定为使用，其余编译目标需要单独开启 |
| 使用BMS手动触发变频水泵故障 | `USE_BMS_DEBUG_PUMPF_ERR` | 禁用：无通过BMS手动触发变频水泵故障&警告<br/>使用：可通过BMS手动触发变频水泵故障&警告 | `DEBUG` 固定为使用，其余编译目标需要单独开启 |
