/******************************************************************************

          版权所有 (C), 2001-2014, 广州市邦普电脑技术开发有限公司

 ******************************************************************************
  文 件 名   : Hdw_Temp.c
  版 本 号   : 初稿
  作    者   : 周志鹏
  生成日期   : 2016年11月7日星期一
  最近修改   :
  功能描述   : 处理硬件上温度
  函数列表   :
  修改历史   :
  1.日    期   : 2016年11月7日星期一
    作    者   : 周志鹏
    修改内容   : 创建文件
  2.日    期   : 2018年2月27日星期二
    作    者   : 吴立刚
    修改内容   : 
                一、为了提高温度刷新频率，做了如下修改
                a、由10ms采集一次AD改为1ms采集一次AD值
                b、方案一:采集同一通道10个AD值后进行一次温度更新(更新时间为4*10*11(温度路数)=440ms)
                c、方案二:通道的4个放大倍数采集完成立即更新温度(更新时间为4*11(温度路数)=44ms)
                
                二、优化温度切换点温度突变，做了如下修改
                a、每个通道的4个放大倍数AD值都采集
                b、采集4个放大倍数AD值后计算对应的4个温度       `
                c、根据4个温度所在的范围再判断真实温度所在区域，若在切换点则进行平滑处理

                三、提高计算温度精度到0.01，
                四、更正断路电阻造成温度只能到-41℃的BUG。
******************************************************************************/

/*----------------------------------------------*
 * 包含头文件                                   *
 *----------------------------------------------*/
#include "Mcu_def.h"
#include "Hdw_Main.h"
#include "includes.h"
#include "Hdw_Temp.h"



/* 外部函数原型说明 */

/* 内部函数原型说明 */




/* 电阻放大10倍,常州惠昌NTC,主测点100度,参考3950-184,R100=0.6744KΩ,B25/50=3950K */
const static I32 NTC_TAb[] =
{
    /*     -50      -49      -48      -47      -46  */
       7062000, 6566000, 6107000, 5685000, 5294000,
    /*     -45      -44      -43      -42      -41  */
       4933000, 4599000, 4289000, 4003000, 3738000,
    /*     -40      -39      -38      -37      -36  */
       3492000, 3264000, 3052000, 2856000, 2673000,
    /*     -35      -34      -33      -32      -31  */
       2504000, 2346000, 2199000, 2062000, 1935000,
    /*     -30      -29      -28      -27      -26  */
       1817000, 1706000, 1603000, 1507000, 1417000,
    /*     -25      -24      -23      -22      -21  */
       1333000, 1255000, 1181000, 1113000, 1049000,
    /*     -20      -19      -18      -17      -16  */
        988800,  932600,  880000,  830600,  784300,
    /*     -15      -14      -13      -12      -11  */
        740900,  700200,  662000,  626000,  592300,
    /*     -10       -9       -8       -7       -6  */
        560600,  530700,  502700,  476300,  451400,
    /*      -5       -4       -3       -2       -1  */
        428000,  406000,  385200,  365600,  347100,
    /*       0        1        2        3        4  */
        329700,  313100,  297500,  282800,  268900,
    /*       5        6        7        8        9  */
        255700,  243300,  231500,  220400,  209900,
    /*      10       11       12       13       14  */
        200000,  190500,  181600,  173200,  165200,
    /*      15       16       17       18       19  */
        157600,  150400,  143600,  137100,  130900,
    /*      20       21       22       23       24  */
        125100,  119500,  114300,  109300,  104500,
    /*      25       26       27       28       29  */
        100000,   95700,   91610,   87710,   84010,
    /*      30       31       32       33       34  */
         80480,   77120,   73910,   70860,   67950,
    /*      35       36       37       38       39  */
         65180,   62530,   60010,   57600,   55310,
    /*      40       41       42       43       44  */
         53110,   51020,   49020,   47110,   45280,
    /*      45       46       47       48       49  */
         43530,   41860,   40270,   38740,   37280,
    /*      50       51       52       53       54  */
         35880,   34540,   33260,   32040,   30860,
    /*      55       56       57       58       59  */
         29730,   28650,   27620,   26630,   25680,
    /*      60       61       62       63       64  */
         24770,   23890,   23050,   22250,   21470,
    /*      65       66       67       68       69  */
         20730,   20020,   19330,   18670,   18040,
    /*      70       71       72       73       74  */
         17430,   16850,   16290,   15750,   15230,
    /*      75       76       77       78       79  */
         14730,   14250,   13780,   13340,   12910,
    /*      80       81       82       83       84  */
         12500,   12100,   11720,   11350,   10990,
    /*      85       86       87       88       89  */
         10650,   10320,    9999,    9692,    9395,
    /*      90       91       92       93       94  */
          9109,    8834,    8568,    8311,    8063,
    /*      95       96       97       98       99  */
          7824,    7593,    7369,    7154,    6946,
    /*     100      101      102      103      104  */
          6744,    6550,    6362,    6180,    6005,
    /*     105      106      107      108      109  */
          5835,    5671,    5512,    5358,    5210,
    /*     110      111      112      113      114  */
          5066,    4927,    4792,    4662,    4535,
    /*     115      116      117      118      119  */
          4413,    4294,    4180,    4069,    3961,
    /*     120      121      122      123      124  */
          3857,    3755,    3657,    3562,    3470,
    /*     125      126      127      128      129  */
          3381,    3294,    3210,    3129,    3050,
    /*     130      131      132      133      134  */
          2973,    2898,    2826,    2756,    2688,
    /*     135      136      137      138      139  */
          2622,    2557,    2495,    2434,    2376,
    /*     140      141      142      143      144  */
          2318,    2263,    2209,    2157,    2106,
    /*     145      146      147      148      149  */
          2056,    2008,    1961,    1915,    1871,
    /*     150      151      152      153      154  */
          1828,    1786,    1745,    1706,    1667,
    /*     155      156      157      158      159  */
          1629,    1593,    1557,    1523,    1489,
    /*     160      161      162      163      164  */
          1456,    1424,    1393,    1363,    1333,
    /*     165      166      167      168      169  */
          1304,    1276,    1249,    1222,    1196,
    /*     170      171      172      173      174  */
          1171,    1146,    1122,    1099,    1076,
    /*     175      176      177      178      179  */
          1054,    1032,    1011,     990,     970,
    /*     180      181      182      183      184  */
           950,     931,     912,     894,     876,
    /*     185      186      187      188      189  */
           859,     842,     825,     809,     793,
    /*     190      191      192      193      194  */
           778,     763,     748,     733,     719,
    /*     195      196      197      198      199  */
           706,     692,     679,     666,     654,
    /*     200      201      202      203      204  */
           641,     630,     618,     606,     595,
    /*     205      206      207      208      209  */
           584,     574,     563,     553,     543,
    /*     210      211      212      213      214  */
           533,     524,     514,     505,     496,
    /*     215      216      217      218      219  */
           487,     479,     470,     462,     454,
    /*     220      221      222      223      224  */
           446,     439,     431,     424,     416,
    /*     225      226      227      228      229  */
           409,     402,     396,     389,     382,
    /*     230      231      232      233      234  */
           376,     370,     364,     358,     352,
    /*     235      236      237      238      239  */
           346,     340,     335,     329,     324,
    /*     240      241      242      243      244  */
           319,     314,     309,     304,     299,
    /*     245      246      247      248      249  */
           294,     290,     285,     281,     276,
    /*     250      251      252      253      254  */
           272,     268,     264,     260,     256,
    /*     255      256      257      258      259  */
           252,     248,     244,     241,     237,
    /*     260 */
           234
};

/* 电阻放大10倍(Ω×10),TCL普通NTC,R25=10.000KΩ,B25/50=4100K */
const static I32 NTC_TAb_TCL_NORMAL[] =
{
    /*  -30       -29       -28       -27       -26       -25       -24       -23       -22       -21  */
    1935430,  1816630,  1705970,  1602830,  1506620,  1416830,  1332960,  1254580,  1181300,  1112730, 

    /*  -20       -19       -18       -17       -16       -15       -14       -13       -12       -11  */
    1048550,   988440,   932120,   879320,   829800,   783340,   739730,   698770,   660300,   624150, 

    /*  -10        -9        -8        -7        -6        -5        -4        -3        -2        -1  */
     590160,   558200,   528130,   499830,   473200,   448110,   424480,   402220,   381240,   361460,

    /*    0        1         2         3         4         5         6         7         8         9  */
     342800,   325200,   308600,   292920,   278120,   264150,   250950,   238480,   226690,   215550, 

    /*   10        11        12        13        14        15        16        17        18        19  */
     205010,   195050,   185620,   176690,   168250,   160250,   152680,   145500,   138700,   132260,

    /*   20        21        22        23        24        25        26        27        28        29  */
     126150,   120360,   114860,   109650,   104700,   100000,    95540,    91300,    87280,    83450, 

    /*   30        31        32        33        34        35        36        37        38        39  */
      79810,    76360,    73070,    69940,    66960,    64130,    61430,    58860,    56410,    54080, 
    
    /*   40        41        42        43        44        45        46        47        48        49  */
      51850,    49730,    47710,    45780,    43940,    42180,    40500,    38900,    37370,    35910, 

    /*   50        51        52        53        54        55        56        57        58        59  */
      34510,    33170,    31900,    30670,    29500,    28380,    27310,    26290,    25300,    24360, 
    
    /*   60        61        62        63        64        65        66        67        68        69  */
      23460,    22600,    21770,    20970,    20210,    19480,    18780,    18110,    17460,    16840, 
    
    /*   70        71        72        73        74        75        76        77        78        79  */
      16250,    15680,    15130,    14600,    14100,    13610,    13140,    12690,    12260,    11850, 
    
    /*   80        81        82        83        84        85        86        87        88        89  */
      11450,    11060,    10690,    10340,    10000,     9670,     9350,     9050,     8760,     8480, 
    
    /*   90        91        92        93        94        95        96        97        98        99  */
       8210,     7950,     7700,     7460,     7230,     7010,     6800,     6590,     6390,     6200, 
    
    /*  100       101       102       103       104       105   */   
       6020,     5850,     5680,     5520,     5370,     5220,     

};

const static I32 NTC_TAb_TCL_DSC[] = 
{
    /*  -40       -39       -38       -37       -36       -35       -34       -33       -32      -31  */
   16420440, 15475670, 14586650, 13750210, 12963340, 12223180, 11527000, 10872210, 10256360, 9677160,

    /*  -30       -29       -28       -27       -26       -25       -24       -23       -22       -21  */
    9132390,  8620010,  8138060,  7684700,  7258210,  6856940,  6479370,  6124050,  5789630,  5474820,
   
    /*  -20       -19       -18       -17       -16       -15       -14       -13       -12       -11  */
    5178450,  4899370,  4636530,  4388950,  4155690,  3935870,  3728690,  3533370,  3349200,  3175490,

    /*  -10        -9        -8        -7        -6        -5        -4        -3        -2        -1  */
    3011610,  2856990,  2711040,  2573260,  2443160,  2320280,  2204180,  2094470,  1990770,  1892720,

    /*    0         1         2         3         4         5         6         7         8         9  */
    1799990,  1712270,  1629260,  1550700,  1476320,  1405890,  1339170,  1275960,  1216050,  1159260,

    /*   10        11        12        13        14        15        16        17        18        19  */
    1105400,  1054330,  1005870,   959880,   916220,   874770,   835410,   798010,   762480,   728710,

    /*   20        21        22        23        24        25        26        27        28        29  */
     696600,   666070,   637030,   609390,   583100,   558070,   534240,   511540,   489920,   469330,

    /*   30        31        32        33        34        35        36        37        38        39  */
     449700,   430980,   413140,   396130,   379890,   364410,   349630,   335520,   322050,   309190,
    
    /*   40        41        42        43        44        45        46        47        48        49  */
     296910,   285170,   273950,   263230,   252980,   243180,   233810,   224850,   216270,   208060,

    /*   50        51        52        53        54        55        56        57        58        59  */
     200210,   192690,   185480,   178590,   171980,   165650,   159580,   153770,   148200,   142850,
    
    /*   60        61        62        63        64        65        66        67        68        69  */
     137730,   132810,   128090,   123570,   119230,   115060,   111050,   107210,   103520,    99970,
    
    /*   70        71        72        73        74        75        76        77        78        79  */
      96560,    93290,    90140,    87110,    84200,    81400,    78710,    76120,    73630,    71230,
    
    /*   80        81        82        83        84        85        86        87        88        89  */
      68920,    66700,    64560,    62490,    60510,    58590,    56750,    54970,    53250,    51600,
    
    /*   90        91        92        93        94        95        96        97        98        99  */
      50000,    48460,    46970,    45540,    44150,    42820,    41520,    40270,    39070,    37900,
    
    /*  100       101       102       103       104       105       106       107       108       109  */   
      36770,    35680,    34630,    33610,    32620,    31660,    30910,    30030,    29180,    28350,

    /*  110       111       112       113       114       115       116       117       118       119  */   
      27550,    26780,    26030,    25300,    24600,    23920,    23260,    22620,    22000,    21410,

    /*  120       121       122       123       124       125       126       127       128       129  */   
      20820,    20260,    19720,    19190,    18680,    18180,    17700,    17230,    16780,    16350,

    /*  130       131       132       133       134       135       136       137       138       139  */   
      15920,    15510,    15110,    14720,    14350,    13990,    13630,    13290,    12960,    12640,

    /*  140       141       142       143       144       145       146       147       148       149  */   
      12330,    12030,    11740,    11460,    11190,    10930,    10670,    10430,    10190,     9960,

    /*  150 */
       9740,
};

const static I32 NTC_TAb_CHANGHONG_DSC[] = 
{
    /*      -45       -44       -43       -42       -41  */
       28250700, 26361100, 24610100, 22986800, 21481000,

    /*      -40       -39       -38       -37       -36       -35       -34       -33       -32       -31  */
       20083500, 18786000, 17580500, 16460100, 15418300, 14449000, 13546800, 12706700, 11923900, 11194300,

    /*      -30       -29       -28       -27       -26       -25       -24       -23       -22       -21  */
       10514000,  9879220,  9286760,  8733500,  8216700,  7733600,  7282000,  6859500,  6464100,  6094000,

    /*      -20       -19       -18       -17       -16       -15       -14       -13       -12       -11  */
        5747300,  5422700,  5118400,  4833100,  4565300,  4314000,  4078000,  3856300,  3648000,  3452100,

    /*      -10        -9        -8        -7        -6        -5        -4        -3        -2        -1  */
        3267900,  3094700,  2931600,  2778100,  2633500,  2497300,  2369000,  2247900,  2133800,  2026100,

    /*        0         1         2         3         4         5         6         7         8         9  */
        1924500,  1828500,  1737900,  1652300,  1571400,  1494900,  1422500,  1354000,  1289200,  1227900,

    /*       10        11        12        13        14        15        16        17        18        19  */
        1169800,  1114800,  1062600,  1013200,   966400,   921930,   879780,   839780,   801810,   765770,

    /*       20        21        22        23        24        25        26        27        28        29  */
         731530,   699010,   668110,   638740,   610810,   584260,   558990,   534950,   512060,   490270,

    /*       30        31        32        33        34        35        36        37        38        39  */
         469510,   449740,   430900,   412940,   395820,   379490,   363920,   349070,   334890,   321360,

    /*       40        41        42        43        44        45        46        47        48        49  */
         308450,   296120,   284340,   273080,   262330,   252050,   242230,   232830,   223850,   215260,

    /*       50        51        52        53        54        55        56        57        58        59  */
         207030,   199170,   191630,   184420,   177510,   170890,   164550,   158480,   152650,   147070,

    /*       60        61        62        63        64        65        66        67        68        69  */
         141710,   136580,   131660,   126930,   122400,   118050,   113870,   109860,   106010,   102310,

    /*       70        71        72        73        74        75        76        77        78        79  */
          98750,    95340,    92060,    88910,    85880,    82960,    80160,    77470,    74870,    72380,

    /*       80        81        82        83        84        85        86        87        88        89  */
          69980,    67670,    65440,    63300,    61240,    59260,    57340,    55500,    53720,    52010,

    /*       90        91        92        93        94        95        96        97        98        99  */
          50360,    48770,    47230,    45750,    44320,    42950,    41620,    40340,    39100,    37910,

    /*      100       101       102       103       104       105       106       107       108       109  */
          36750,    35640,    34570,    33530,    32530,    31560,    30620,    29720,    28840,    28000,

    /*      110       111       112       113       114       115       116       117       118       119  */
          27180,    26390,    25630,    24890,    24170,    23480,    22810,    22170,    21540,    20940,

    /*      120       121       122       123       124       125       126       127       128       129  */
          20350,    19780,    19230,    18700,    18180,    17680,    17200,    16730,    16280,    15840,

    /*      130       131       132       133       134       135       136       137       138       139  */
          15410,    15000,    14600,    14210,    13830,    13470,    13110,    12770,    12440,    12110,

    /*      140       141       142       143       144       145       146       147       148       149  */
          11800,    11490,    11200,    10910,    10630,    10360,    10100,     9844,     9597,     9356,

    /*      150       151       152       153       154       155       156       157       158       159  */
           9123,     8896,     8676,     8462,     8254,     8051,     7855,     7664,     7478,     7297,

    /*      160       161       162       163       164       165       166       167       168       169  */
           7122,     6951,     6785,     6623,     6466,     6313,     6165,     6020,     5879,     5742,

    /*      170       171       172       173       174       175       176       177       178       179  */
           5609,     5479,     5353,     5230,     5110,     4994,     4880,     4770,     4662,     4557,

    /*      180       181       182       183       184       185       186       187       188       189  */
           4455,     4356,     4259,     4164,     4072,     3982,     3895,     3810,     3727,     3646,

    /*      190       191       192       193       194       195       196       197       198       199  */
           3567,     3490,     3415,     3341,     3270,     3200,     3132,     3066,     3001,     2938,

    /*      200       201       202       203       204       205       206       207       208       209  */
           2877,     2817,     2758,     2701,     2645,     2591,     2538,     2486,     2435,     2386,

    /*      210       211       212       213       214       215       216       217       218       219  */
           2337,     2290,     2244,     2199,     2155,     2112,     2070,     2029,     1989,     1950,

    /*      220       221       222       223       224       225       226       227       228       229  */
           1912,     1875,     1838,     1802,     1768,     1734,     1700,     1668,     1636,     1605,

    /*      230       231       232       233       234       235       236       237       238       239  */
           1574,     1544,     1515,     1487,     1459,     1432,     1405,     1379,     1354,     1329,

    /*      240       241       242       243       244       245       246       247       248       249  */
           1304,     1280,     1257,     1234,     1212,     1190,     1168,     1147,     1127,     1107,

    /*      250       251       252       253       254       255       256       257       258       259  */
           1087,     1068,     1049,     1030,     1012,      994,      977,      960,      943,      927,

    /*      260       261       262       263       264       265       266       267       268       269  */
            911,      895,      880,      865,      850,      836,      821,      808,      794,      781,

    /*      270       271       272       273       274       275       276       277       278       279  */
            768,      755,      742,      730,      718,      706,      694,      683,      672,      661,

    /*      280       281       282       283       284       285       286       287       288       289  */
            650,      640,      629,      619,      609,      600,      590,      581,      571,      562,

    /*      290       291       292       293       294       295       296       297       298       299  */
            554,      545,      536,      528,      520,      512,      504,      496,      489,      481,

    /*      300  */
            474,
};

const static I32 NTC_TAb_PAIWO_NORMAL[] = 
{
    /*  -50       -49       -48       -47       -46       -45       -44       -43       -42       -41  */
    6028599,  5635622,  5270385,  4930793,  4614920,  4320992,  4047377,  3792572,  3555190,  3333955, 

    /*  -40       -39       -38       -37       -36       -35       -34       -33       -32       -31  */
    3127690,  2935306,  2755803,  2588254,  2431804,  2285664,  2149103,  2021447,  1902071,  1790397, 

    /*  -30       -29       -28       -27       -26       -25       -24       -23       -22       -21  */
    1685890,  1588055,  1496433,  1410600,  1330160,  1254748,  1184026,  1117679,  1055413,   996959, 

    /*  -20       -19       -18       -17       -16       -15       -14       -13       -12       -11  */
     942064,   890494,   842031,   796472,   753629,   713328,   675403,   639705,   606090,   574427, 

    /*  -10        -9        -8        -7        -6        -5        -4        -3        -2        -1  */
     544594,   516475,   489963,   464959,   441369,   419107,   398090,   378245,   359498,   341785, 

    /*    0         1         2         3         4         5         6         7         8         9  */
     325042,   309084,   293990,   279709,   266195,   253403,   241291,   229819,   218952,   208654, 

    /*   10        11        12        13        14        15        16        17        18        19  */
     198893,   189639,   180863,   172538,   164640,   157143,   150027,   143270,   136853,   130756, 

    /*   20        21        22        23        24        25        26        27        28        29  */
     124962,   119455,   114220,   109241,   104506,   100000,    95712,    91631,    87745,    84044, 

    /*   30        31        32        33        34        35        36        37        38        39  */
      80518,    77159,    73958,    70907,    67997,    65222,    62575,    60050,    57640,    55339, 

    /*   40        41        42        43        44        45        46        47        48        49  */
      53142,    51044,    49040,    47125,    45296,    43546,    41874,    40275,    38746,    37282, 

    /*   50        51        52        53        54        55        56        57        58        59  */
      35882,    34575,    33321,    32115,    30957,    29844,    28775,    27747,    26760,    25812, 

    /*   60        61        62        63        64        65        66        67        68        69  */
      24900,    24024,    23181,    22372,    21594,    20846,    20126,    19435,    18770,    18130, 

    /*   70        71        72        73        74        75        76        77        78        79  */
      17515,    16924,    16355,    15807,    15281,    14774,    14286,    13817,    13365,    12931, 

    /*   80        81        82        83        84        85        86        87        88        89  */
      12512,    12109,    11722,    11348,    10988,    10642,    10308,     9987,     9677,     9378, 

    /*   90        91        92        93        94        95        96        97        98        99  */
       9090,     8813,     8546,     8288,     8039,     7800,     7569,     7345,     7130,     6923, 

    /*  100       101       102       103       104       105       106       107       108       109  */   
       6722,     6529,     6342,     6161,     5987,     5818,     5655,     5497,     5345,     5197, 

    /*  110       111       112       113       114       115       116       117       118       119  */   
       5055,     4917,     4783,     4654,     4529,     4407,     4290,     4176,     4066,     3960, 

    /*  120       121       122       123       124       125       126       127       128       129  */   
       3856,     3756,     3659,     3565,     3474,     3386,     3300,     3217,     3136,     3058, 

    /*  130       131       132       133       134       135       136       137       138       139  */   
       2982,     2908,     2837,     2767,     2700,     2635,     2571,     2509,     2449,     2391, 

    /*  140       141       142       143       144       145       146       147       148       149  */   
       2335,     2280,     2226,     2174,     2124,     2075,     2027,     1981,     1936,     1892, 

    /*  150       151       152       153       154       155       156       157       158       159  */
       1849,     1807,     1766,     1726,     1687,     1649,     1612,     1576,     1541,     1507, 

    /*  160       161       162       163       164       165       166       167       168       169  */
       1474,     1442,     1411,     1380,     1351,     1322,     1293,     1266,     1239,     1213, 

    /*  170       171       172       173       174       175       176       177       178       179  */   
       1188,     1163,     1139,     1115,     1092,     1070,     1048,     1027,     1006,      986, 

    /*  180       181       182       183       184       185       186       187       188       189  */   
        966,      946,      928,      909,      891,      874,      857,      840,      824,      808,     

    /*  190       191       192       193       194       195       196       197       198       199  */   
        792,      777,      762,      748,      734,      720,      707,      693,      681,      668,     

    /*  200       201       202       203       204       205       206       207       208       209  */   
        656,      644,      633,      622,      611,      600,      590,      580,      570,      560,     

    /*  210       211       212       213       214       215       216       217       218       219  */   
        550,      541,      532,      523,      514,      505,      497,      489,      481,      473,     

    /*  220       221       222       223       224       225       226       227       228       229  */
        465,      458,      450,      443,      436,      429,      422,      415,      409,      402,     

    /*  230       231       232       233       234       235       236       237       238       239  */
        396,      390,      384,      378,      372,      366,      360,      355,      350,      344,     

    /*  240       241       242       243       244       245       246       247       248       249  */   
        339,      334,      329,      324,      319,      315,      310,      305,      301,      296,     

    /*  250       251       252       253       254       255       256       257       258       259  */   
        292,      288,      284,      280,      276,      272,      268,      264,      260,      257,     

    /*  260       261       262       263       264       265       266       267       268       269  */
        253,      250,      246,      243,      239,      236,      233,      230,      227,      224,     

    /*  270       271       272       273       274       275       276       277       278       279  */
        221,      218,      215,      212,      209,      206,      204,      201,      198,      196,     

    /*  280       281       282       283       284       285       286       287       288       289  */   
        193,      191,      188,      186,      183,      181,      179,      177,      174,      172,     

    /*  290       291       292       293       294       295       296       297       298       299  */   
        170,      168,      166,      164,      162,      160,      158,      156,      154,      152,     

    /*  300       301       302       303       304       305       306       307       308       309  */
        150,      148,      147,      145,      143,      141,      140,      138,      137,      135,     

    /*  310       311       312       313       314       315       316       317       318       319  */
        133,      132,      130,      129,      127,      126,      124,      123,      122,      120,     

    /*  320       321       322       323       324       325       326       327   */
        119,      118,      116,      115,      114,      112,      111,      110,         
};

/* 电阻放大10倍(Ω×10),纽恩泰NTC,R25=5.000KΩ,B25/50=3470K */
const static I32 NTC_TAb_NIUENTAI_NORMAL[] =
{

    /*       -40,       -39,       -38,       -37,       -36,       -35,       -34,       -33,       -32,       -31,*/
         1092000,   1031000,    973600,    919600,    869000,    821500,    776800,    734800,    695400,    658300,

    /*       -30,       -29,       -28,       -27,       -26,       -25,       -24,       -23,       -22,       -21,*/
          623400,    590600,    559600,    530500,    503100,    477300,    452900,    429900,    408200,    387800,

    /*       -20,       -19,       -18,       -17,       -16,       -15,       -14,       -13,       -12,       -11,*/
          368500,    350200,    333000,    316700,    301400,    286800,    273100,    260000,    247700,    236100,

    /*       -10,        -9,        -8,        -7,        -6,        -5,        -4,        -3,        -2,        -1,*/
          225000,    214500,    204600,    195200,    186300,    177800,    169800,    162200,    155000,    148100,

    /*         0,         1,         2,         3,         4,         5,         6,         7,         8,         9,*/
          141600,    135400,    129500,    123900,    118600,    113500,    108700,    104100,     99750,     95590,

    /*        10,        11,        12,        13,        14,        15,        16,        17,        18,        19,*/
           91620,     87850,     84250,     80820,     77540,     74420,     71440,     68600,     65890,     63300,

    /*        20,        21,        22,        23,        24,        25,        26,        27,        28,        29,*/
           60820,     58460,     56200,     54040,     51970,     50000,     48110,     46300,     44570,     42920,

    /*        30,        31,        32,        33,        34,        35,        36,        37,        38,        39,*/
           41330,     39820,     38360,     36970,     35630,     34350,     33130,     31950,     30820,     29740,

    /*        40,        41,        42,        43,        44,        45,        46,        47,        48,        49,*/
           28700,     27700,     26740,     25830,     24940,     24089,     23280,     22490,     21740,     21020,

    /*        50,        51,        52,        53,        54,        55,        56,        57,        58,        59,*/
           20320,     19650,     19010,     18390,     17790,     17210,     16660,     16130,     15620,     15120,

    /*        60,        61,        62,        63,        64,        65,        66,        67,        68,        69,*/
           14650,     14190,     13740,     13320,     12910,     12509,     12130,     11760,     11400,     11060,

    /*        70,        71,        72,        73,        74,        75,        76,        77,        78,        79,*/
           10730,     10410,     10100,      9798,      9510,      9231,      8962,      8702,      8450,      8207,

    /*        80,        81,        82,        83,        84,        85,        86,        87,        88,        89,*/
            7972,      7744,      7524,      7312,      7106,      6907,      6714,      6527,      6347,      6172,

    /*        90,        91,        92,        93,        94,        95,        96,        97,        98,        99,*/
            6003,      5839,      5680,      5526,      5377,      5232,      5092,      4957,      4825,      4697,

    /*       100,       101,       102,       103,       104,       105,*/
            4574,      4454,      4337,      4225,      4115,      4009,

};

/* 电阻放大10倍(Ω×10),纽恩泰NTC,R25=50.000KΩ,B25/50=3950K */
const static I32 NTC_TAb_NIUENTAI_DSC[] =
{

    /*       -40,       -39,       -38,       -37,       -36,       -35,       -34,       -33,       -32,       -31,*/
        15870000,  14870000,  13950000,  13090000,  12290000,  11540000,  10840000,  10190000,   9579000,   9010000,

    /*       -30,       -29,       -28,       -27,       -26,       -25,       -24,       -23,       -22,       -21,*/
         8479000,   7982000,   7517000,   7082000,   6674000,   6293000,   5935000,   5600000,   5286000,   4991000,

    /*       -20,       -19,       -18,       -17,       -16,       -15,       -14,       -13,       -12,       -11,*/
         4715000,   4455000,   4211000,   3982000,   3767000,   3564000,   3374000,   3194000,   3026000,   2867000,

    /*       -10,        -9,        -8,        -7,        -6,        -5,        -4,        -3,        -2,        -1,*/
         2717000,   2576000,   2443000,   2318000,   2200000,   2088000,   1983000,   1884000,   1790000,   1701000,

    /*         0,         1,         2,         3,         4,         5,         6,         7,         8,         9,*/
         1617000,   1538000,   1463000,   1392000,   1325000,   1262000,   1202000,   1145000,   1091000,   1040000,

    /*        10,        11,        12,        13,        14,        15,        16,        17,        18,        19,*/
          991400,    945500,    902000,    860600,    821400,    784200,    748800,    715300,    683400,    653100,

    /*        20,        21,        22,        23,        24,        25,        26,        27,        28,        29,*/
          624200,    596900,    570800,    546000,    522400,    500000,    478600,    458300,    438900,    420500,

    /*        30,        31,        32,        33,        34,        35,        36,        37,        38,        39,*/
          402900,    386100,    370100,    354900,    340300,    326500,    313200,    300600,    288500,    277000,

    /*        40,        41,        42,        43,        44,        45,        46,        47,        48,        49,*/
          266000,    255500,    245400,    235800,    226700,    217900,    209500,    201500,    193800,    186400,

    /*        50,        51,        52,        53,        54,        55,        56,        57,        58,        59,*/
          179400,    172700,    166200,    160000,    154100,    148500,    143000,    137800,    132800,    128000,

    /*        60,        61,        62,        63,        64,        65,        66,        67,        68,        69,*/
          123400,    119000,    114800,    110700,    106900,    103100,     99530,     96080,     92770,     89590,

    /*        70,        71,        72,        73,        74,        75,        76,        77,        78,        79,*/
           86530,     83590,     80770,     78050,     75440,     72930,     70510,     68190,     65950,     63800,

    /*        80,        81,        82,        83,        84,        85,        86,        87,        88,        89,*/
           61730,     59730,     57810,     55960,     54180,     52460,     50800,     49210,     47670,     46190,

    /*        90,        91,        92,        93,        94,        95,        96,        97,        98,        99,*/
           44760,     43380,     42050,     40770,     39530,     38330,     37180,     36070,     34990,     33950,

    /*       100,       101,       102,       103,       104,       105,       106,       107,       108,       109,*/
           32950,     31980,     31050,     30140,     29270,     28420,     27600,     26810,     26050,     25310,

    /*       110,       111,       112,       113,       114,       115,       116,       117,       118,       119,*/
           24600,     23900,     23230,     22590,     21960,     21350,     20760,     20190,     19640,     19110,

    /*       120,       121,       122,       123,       124,       125,       126,       127,       128,       129,*/
           18590,     17900,     17420,     16960,     16510,     16070,     15650,     15240,     14840,     14450,

    /*       130,       131,       132,       133,       134,       135,       136,       137,       138,       139,*/
           14080,     13720,     13370,     13020,     12690,     12370,     12060,     11760,     11470,     11180,

    /*       140,       141,       142,       143,       144,       145,       146,       147,       148,       149,*/
           10910,     10640,     10380,     10130,      9880,      9641,      9409,      9184,      8965,      8751,

    /*       150,*/
            8544,

};

static TAB_DATA s_tabRTC_100[] =
{
    /* 邦普 */
    {NTC_TAb,   311, -5000,  26000,  100},                  /* 温度放大100倍 */

    /* TCL */
    {NTC_TAb_TCL_NORMAL, 136, -3000, 10500, 100},           /* 温度放大100倍 */
    {NTC_TAb_TCL_DSC, 191, -4000, 15000, 100},              /* 温度放大100倍 */

    /* 长虹 */
    {NTC_TAb_CHANGHONG_DSC, 346, -4500, 30000, 100},        /* 温度放大100倍 */

    /* 派沃 */
    {NTC_TAb_PAIWO_NORMAL, 378, -5000, 32700, 100},         /* 温度放大100倍 */

    /* 纽恩泰 */
    {NTC_TAb_NIUENTAI_NORMAL, 146, -4000, 10500, 100},      /* 温度放大100倍 */
    {NTC_TAb_NIUENTAI_DSC, 191, -4000, 15000, 100},         /* 温度放大100倍 */

};

/* 内部变量 */
U08 Hdw_Temp_NTC_Type[MAX_TEMP_NUM];

I16 Hdw_Temp[MAX_TEMP_NUM];  //底层温度单位0.01℃

#define NTC_TEMP_HIGH       0   // 高温型
#define NTC_TEMP_LOW        1   // 低温型
#define NTC_TEMP_NORMAL     2   // 常温型


typedef struct tagHDW_NTC_TBL {
    U08 ad_idx;         // AD编号索引
    U08 ntc_temp_type;  // NTC类型
}HDW_NTC_TBL;
const HDW_NTC_TBL HdwNtcAdTbl [MAX_TEMP_NUM] = {
    {AD_IDX_NTC_1 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_2 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_3 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_4 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_5 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_6 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_7 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_8 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_9 ,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_10,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_11,  NTC_TEMP_NORMAL}, 
    {AD_IDX_NTC_12,  NTC_TEMP_NORMAL}, 
};

/*******************************************************************************
 函 数: HDW_Temp_Init
 功 能: 初始化本模块变量
 参 数: 空
 返 回: 空
 其 它: 
*******************************************************************************/
void HDW_Temp_Init(void)
{

    /* 初始化TEMP类型 */
 
    /* 初始化TEMP变量 */
    ARRSET(Hdw_Temp, SENSOR_NOEXIST);
}








/*******************************************************************************
 函 数: AD_RtoT()
 功 能: 由电阻求温度(摄氏度)，温度放大100倍
 参 数: v--放大10倍的电阻值，如实际参数15代表1.5欧姆; 
 返 回: 放大100倍的温度值，如返回值15代表0.15摄氏度
 其 它: 空 
*******************************************************************************/
static I16 AD_RtoT(U32 v, U08 ntc_opt)
{
    I16 tmp = 0;
    U16 k, head, trail;
    TAB_DATA *pRTC ;


    pRTC= &s_tabRTC_100[ntc_opt];
    
    head = 0;
    trail = pRTC->num - 1;
    

    if (v >= pRTC->v[head])     
    {
        tmp = pRTC->t0;     /* 最低测量温度 */
    }
    else if (v <= pRTC->v[trail])   
    {
        tmp = pRTC->tn;     /* 最高测量温度 */
    }
    else
    {
        k = (head + trail) >> 1;
        do
        {
            if (v > pRTC->v[k])             /* 前部 */
            {
                trail = k;      
                k = (head + trail) >> 1;
            }
            else if (v < pRTC->v[k+1])      /* 后部 */
            {
                head = k + 1;   
                k = (head + trail) >> 1;
            }
            else
            {
                break;
            }
        
        } while (1);
        tmp = pRTC->t0 + pRTC->td * (I16)k;
        tmp += (I16)((U32)pRTC->td * (pRTC->v[k] - v) / (pRTC->v[k] - pRTC->v[k+1]));
       
    }

    return tmp;
}



static void HDW_GetOneNtcTemp(I16 *pT, U08 channel)
{
    #define R_10K_SHORT 50      	/* 短路电阻值 */
    #define R_10K_BREAK 710000  	/* 断路电阻值 */ 

//	#define R_50K_SHORT 8000      	/* 短路电阻值 */
//  #define R_50K_BREAK 910000  	/* 断路电阻值 */ 
	
    #define NOR_SCR         10000L  /* 常温，串联电阻10k   */
    #define HIGH_SCR         3900L  /* 高温，串联电阻3.9k */
    #define RMUL           	   10L  /* 电阻放大10倍 */

    U08 ntc_opt;
    U32 r;         /* 电阻 */
//  U32 r_scr;     /* 串联电阻 */
    #define r_scr             NOR_SCR
    U16 adFilter;
    I16 samp_Temp[MAX_TEMP_NUM];	//温度采样，4个放大倍数的温度值
    
    if (channel >= MAX_TEMP_NUM)
    {
        *pT = SENSOR_NOEXIST;
        return;
    }



    if (!HDW_AdcUpdateAdVal(&adFilter, HdwNtcAdTbl[channel].ad_idx, HDW_UPDATE_VOL_BY_ONE_TIMES))
    {
        return;
    }
        
    TestCurTmpAd(channel) = adFilter;    

    adFilter = HDW_AdcCompensate(adFilter);
    
	if (adFilter < AD_MAX)
    {  
//      switch (HdwNtcAdTbl[channel].ntc_temp_type)
//      {
//          case NTC_TEMP_HIGH:
//          case NTC_TEMP_LOW:
//          default:
//              r_scr = NOR_SCR;
//              break;
//      }
        
        if (adFilter >= (U32)0xFFFFFFFF/(r_scr*RMUL)) // 防超界
        {
            r = ((U32)adFilter*r_scr/(AD_MAX-adFilter))*RMUL;
        }
        else
        {
            r = ((U32)adFilter*r_scr*RMUL)/(AD_MAX-adFilter);
        }
    }
    else
    { 
		r = (U32)R_10K_BREAK*RMUL;
    }

    if (TestProgStaus != TPS_NO_TEST_CMD)
    {
        ntc_opt = NTC_PUNP_NORMAL_10K;
    }
    else
    {
        ntc_opt = Hdw_Temp_NTC_Type[channel];
//        ntc_opt = (channel == 3) ? NTC_TCL_DSC_5K : NTC_TCL_NORMAL_10K;
    }
 
	samp_Temp[channel] = AD_RtoT(r, ntc_opt);      

    if (r <= (U32)R_10K_SHORT*RMUL)
    {
        *pT = SENSOR_SHORTED;
    }
    else if (r >= (U32)R_10K_BREAK*RMUL)
    {
        *pT = SENSOR_BREAKED;
    }
    else
    {
        *pT = samp_Temp[channel];   // 两位小数
    }
}



/*****************************************************************************
函  数 : HDW_GetAllTemp()
功  能 : 
参  数 : 无
返  回 : 无
其  他 : 无
*****************************************************************************/
void HDW_GetAllTemp(void)
{
    U08 i;
    
    for (i=0; i<MAX_TEMP_NUM; i++)
    {
        HDW_GetOneNtcTemp(&Hdw_Temp[i], i);
    }
}

/*****************************************************************************
函  数 : PunpGetTemp()
功  能 : 读取温度接口函数,温度放大100倍
参  数 : I16 TempBuf[] : 温度缓存区
         U16 TempNum   : 温度个数
返  回 : TRUE: 获取正确, FALSE: 范围超界
其  他 : 无
*****************************************************************************/
BOL PunpGetTemp(I16 TempBuf[], U16 TempNum)
{
    U08 i;

    if (TempNum > MAX_TEMP_NUM)
        return FALSE;
    
    for (i=0; i<TempNum; i++)
    {
        TempBuf[i] = Hdw_Temp[i];
    }    

    return TRUE;
}

