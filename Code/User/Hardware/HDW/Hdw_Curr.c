/******************************************************************************

          版权所有 (C), 2001-2014, 广州市邦普电脑技术开发有限公司

 ******************************************************************************
  文 件 名   : Hdw_Curr.c
  版 本 号   : 初稿
  作    者   : // zzp v160a7
  生成日期   : 2016年11月8日星期二
  最近修改   :
  功能描述   : 处理电流
  函数列表   :
  修改历史   :
  1.日    期   : 2016年11月8日星期二
    作    者   : // zzp v160a7
    修改内容   : 创建文件

******************************************************************************/

/*----------------------------------------------*
 * 包含头文件                                   *
 *----------------------------------------------*/
#include "Mcu_def.h"
#include "Hdw_Main.h"
#include "Hdw_Curr.h"
#include "Includes.h"
/*----------------------------------------------*
 * 外部变量说明                                 *
 *----------------------------------------------*/
#if MAX_CUR_NUM != 0
/*----------------------------------------------*
 * 外部函数原型说明                             *
 *----------------------------------------------*/
extern void MCU_GetAllCurAdCh(U16 Cur_Ad[]);
/*----------------------------------------------*
 * 内部函数原型说明                             *
 *----------------------------------------------*/

/*----------------------------------------------*
 * 全局变量                                     *
 *----------------------------------------------*/

/*----------------------------------------------*
 * 模块级变量                                   *
 *----------------------------------------------*/
//GSTATIC CUR_DATA CurCell;
GSTATIC I16 Hdw_Cur[MAX_CUR_NUM];
//GSTATIC I16 curr_type[MAX_CUR_NUM];
/*----------------------------------------------*
 * 常量定义                                     *
 *----------------------------------------------*/
typedef struct tagCURDATA
{
    U16 AD;
    U16 cur;
}CURDATA;


/* 注释部分为10位ADC，参考3.05V时对应的AD值 
   新AD为10位ADC,参考3.05V,16次连续采样AD值 */

/* 25A 电流互感器参数表 */
CURDATA const TabCUR_25A[]=
{/* AD               电流0.1A */
 { /* 964 */ 964*16, MAX_CURR_25A},
 { /* 951 */ 951*16,    760   },   
 { /* 937 */ 937*16,    720   },   
 { /* 923 */ 923*16,    680   },   
 { /* 906 */ 906*16,    640   },   
 { /* 889 */ 889*16,    600   },   
 { /* 869 */ 869*16,    560   },   
 { /* 846 */ 846*16,    520   },   
 { /* 821 */ 821*16,    480   },   
 { /* 792 */ 792*16,    440   },   
 { /* 776 */ 776*16,    420   },   
 { /* 758 */ 758*16,    400   },   
 { /* 740 */ 740*16,    380   },   
 { /* 719 */ 719*16,    360   },   
 { /* 697 */ 697*16,    340   },   
 { /* 672 */ 672*16,    320   },   
 { /* 645 */ 645*16,    300   },   
 { /* 615 */ 615*16,    280   },   
 { /* 582 */ 582*16,    260   },   
 { /* 547 */ 547*16,    240   },   
 { /* 512 */ 512*16,    220   },   
 { /* 470 */ 470*16,    200   },   
 { /* 425 */ 425*16,    180   },   
 { /* 378 */ 378*16,    160   },   
 { /* 329 */ 329*16,    140   },   
 { /* 280 */ 280*16,    120   },   
 { /* 229 */ 229*16,    100   },   
 { /* 217 */ 217*16,    95    },   
 { /* 204 */ 204*16,    90    },   
 { /* 191 */ 191*16,    85    },   
 { /* 179 */ 179*16,    80    },   
 { /* 166 */ 166*16,    75    },   
 { /* 153 */ 153*16,    70    },   
 { /* 142 */ 142*16,    65    },   
 { /* 129 */ 129*16,    60    },   
 { /* 116 */ 116*16,    55    },   
 { /* 104 */ 104*16,    50    },   
 { /*  91 */  91*16,    45    },   
 { /*  80 */  80*16,    40    },   
 { /*  68 */  68*16,    35    },   
 { /*  56 */  56*16,    30    },   
 { /*  54 */  54*16,    29    },   
 { /*  51 */  51*16,    28    },   
 { /*  49 */  49*16,    27    },   
 { /*  47 */  47*16,    26    },   
 { /*  44 */  44*16,    25    },   
 { /*  42 */  42*16,    24    },   
 { /*  40 */  40*16,    23    },   
 { /*  38 */  38*16,    22    },   
 { /*  35 */  35*16,    21    },   
 { /*  33 */  33*16,    20    },   
 { /*  31 */  31*16,    19    },   
 { /*  29 */  29*16,    18    },   
 { /*  27 */  27*16,    17    },   
 { /*  25 */  25*16,    16    },   
 { /*  22 */  22*16,    15    },   
 { /*  20 */  20*16,    14    },   
 { /*  18 */  18*16,    13    },   
 { /*  16 */  16*16,    12    },   
 { /*  14 */  14*16,    11    },   
 { /*  12 */  12*16,    10    },   
 { /*  11 */  11*16,    9     },   
 { /*   9 */   9*16,    8     },   
 { /*   7 */   7*16,    7     },   
 { /*   5 */   5*16,    6     },   
 { /*   4 */   4*16,    5     },   
 { /*   3 */   3*16,    4     },   
 { /*   2 */   2*16,    3     },   
 { /*   1 */   1*16,    2     },   
 { /*   0 */   0*16,    1     },   
};

/* 35A 电流互感器参数表 */
CURDATA const TabCUR_35A[]=
{/* AD               电流0.1A */
 { /*1022*/ 1022*16, MAX_CURR_35A},
 { /*1003*/ 1003*16,    760   },   
 { /* 983*/  983*16,    720   },   
 { /* 962*/  962*16,    680   },   
 { /* 941*/  941*16,    640   },   
 { /* 912*/  912*16,    600   },   
 { /* 882*/  882*16,    560   },   
 { /* 848*/  848*16,    520   },   
 { /* 810*/  810*16,    480   },   
 { /* 767*/  767*16,    440   },   
 { /* 742*/  742*16,    420   },   
 { /* 718*/  718*16,    400   },   
 { /* 691*/  691*16,    380   },   
 { /* 663*/  663*16,    360   },   
 { /* 632*/  632*16,    340   },   
 { /* 601*/  601*16,    320   },   
 { /* 567*/  567*16,    300   },   
 { /* 533*/  533*16,    280   },   
 { /* 496*/  496*16,    260   },   
 { /* 459*/  459*16,    240   },   
 { /* 423*/  423*16,    220   },   
 { /* 384*/  384*16,    200   },   
 { /* 343*/  343*16,    180   },   
 { /* 302*/  302*16,    160   },   
 { /* 260*/  260*16,    140   },   
 { /* 217*/  217*16,    120   },   
 { /* 175*/  175*16,    100   },   
 { /* 164*/  164*16,    95    },   
 { /* 154*/  154*16,    90    },   
 { /* 144*/  144*16,    85    },   
 { /* 133*/  133*16,    80    },   
 { /* 122*/  122*16,    75    },   
 { /* 112*/  112*16,    70    },   
 { /* 102*/  102*16,    65    },   
 { /*  92*/   92*16,    60    },   
 { /*  81*/   81*16,    55    },   
 { /*  71*/   71*16,    50    },   
 { /*  62*/   62*16,    45    },   
 { /*  52*/   52*16,    40    },   
 { /*  43*/   43*16,    35    },   
 { /*  34*/   34*16,    30    },   
 { /*  33*/   33*16,    29    },   
 { /*  31*/   31*16,    28    },   
 { /*  29*/   29*16,    27    },   
 { /*  28*/   28*16,    26    },   
 { /*  26*/   26*16,    25    },   
 { /*  25*/   25*16,    24    },   
 { /*  22*/   22*16,    23    },   
 { /*  21*/   21*16,    22    },   
 { /*  18*/   18*16,    21    },   
 { /*  17*/   17*16,    20    },   
 { /*  16*/   16*16,    19    },   
 { /*  14*/   14*16,    18    },   
 { /*  13*/   13*16,    17    },   
 { /*  12*/   12*16,    16    },   
 { /*  11*/   11*16,    15    },   
 { /*  10*/   10*16,    14    },   
 { /*   9*/    9*16,    13    },   
 { /*   8*/    8*16,    12    },   
 { /*   7*/    7*16,    11    },   
 { /*   5*/    5*16,    10    },   
 { /*   5*/    5*16,    9     },   
 { /*   4*/    4*16,    8     },   
 { /*   3*/    3*16,    7     },   
 { /*   2*/    2*16,    6     },   
 { /*   2*/    2*16,    5     },   
 { /*   1*/    1*16,    4     },   
 { /*   1*/    1*16,    3     },   
 { /*   0*/    0*16,    2     },   
 { /*   0*/    0*16,    1     },   
};

CURDATA const TabCUR_50A[] =
{
	{	920*16,		MAX_CURR_50A},
	{	917*16,		1180,   },
	{	914*16,		1160,   },
	{	911*16,		1140,   },
	{	908*16,		1120,  	},
	{	905*16,		1100, 	},
	{	899*16,		1080,  	},
	{	896*16,		1060,  	},
	{	892*16,		1040, 	},
	{	887*16,		1020,	},
  	{	882*16,		1000,  	},
  	{	876*16,		980,   	},
  	{	870*16,		960,   	},
  	{	864*16,		940,   	},
  	{	857*16,		920,  	},
  	{	850*16,		900, 	},
  	{	842*16,		880,  	},
	{	833*16,		860,  	},
	{	824*16,		840,  	},
	{	815*16,		820,	},
  	{	805*16,		800,	},
  	{	794*16,		780,   	},
  	{	783*16,		760,  	},
  	{	771*16,		740,   	},
  	{	757*16,		720,  	},
  	{	744*16,		700, 	},
  	{	737*16,		690,  	},
  	{	731*16,		680,    },
  	{	724*16,		670,  	},
  	{	717*16,		660,	},
  	{	709*16,		650,	},
  	{	701*16,		640,   	},
  	{	693*16,		630,  	},
  	{	686*16,		620,   	},
  	{	678*16,		610,  	},
  	{	669*16,		600, 	},
  	{	660*16,		590,  	},
  	{	652*16,		580,    },
  	{	642*16,		570,  	},
  	{	633*16,		560,	},
  	{	624*16,		550, 	},
  	{	614*16,		540,    },
  	{	605*16,		530,   	},
  	{	595*16,		520,   	},
  	{	585*16,		510,  	},
  	{	575*16,		500,  	},
  	{	563*16,		490,  	},
  	{	553*16,		480,    },
  	{	542*16,		470,  	},
  	{	531*16,		460,	},
	{	520*16,		450,	},
	{	509*16, 	440, 	},
	{	498*16, 	430,   	},
	{	488*16, 	420,  	},
	{	475*16, 	410,  	},
	{	464*16, 	400,   	}, 
	{	452*16, 	390,  	},
	{	441*16, 	380,  	}, 
	{	428*16, 	370,  	},
	{	417*16, 	360,	},   
	{	405*16,		350, 	},
	{	392*16, 	340,   	}, 
	{	381*16, 	330,   	}, 
	{	369*16, 	320,   	}, 
	{	357*16, 	310,  	},
	{	345*16, 	300, 	},
	{	333*16, 	290,  	}, 
	{	321*16, 	280,  	},
	{	309*16, 	270,  	},
	{	297*16, 	260,	},
	{	285*16, 	250,	},
	{	273*16, 	240,   	},
	{	261*16, 	230,   	}, 
	{	249*16, 	220,   	}, 
	{	236*16, 	210,  	},
	{	224*16, 	200, 	},
	{	212*16, 	190,  	},
	{	200*16, 	180,	}, 
	{	188*16, 	170,  	},
	{	176*16, 	160,	},  
	{	164*16,		150,	},
	{	152*16, 	140,	}, 
	{	140*16, 	130,   	}, 
	{	128*16, 	120,   	}, 
	{	116*16, 	110,  	},
	{	104*16, 	100,  	},
	{	 92*16,  	90,  	},
	{	 81*16,  	80,    	},
	{	 69*16,  	70,  	},
	{	 58*16,  	60,		},
	{	 46*16, 	50,		},
	{	 45*16,  	49, 	},  
	{	 44*16,  	48,   	},
	{	 43*16,  	47,		},
	{	 42*16,  	46,  	},
	{	 41*16,  	45,   	}, 
	{	 40*16,  	44,  	},
	{	 39*16,  	43,    	}, 
	{	 37*16,  	42,  	}, 
	{	 36*16,  	41,		},
	{	 35*16,  	40,		}, 
	{	 34*16,  	39,  	}, 
	{	 33*16,  	38,   	}, 
	{	 32*16,  	37,  	},
	{	 31*16,  	36,  	},
	{	 30*16,  	35,   	}, 
	{	 29*16,  	34,  	},
	{	 27*16,  	33,    	},
	{	 26*16,  	32,  	}, 
	{	 25*16, 	31,		},
	{	 23*16,  	29,		}, 
	{	 21*16,  	27,  	},  
	{	 19*16,  	25,   	},  
	{	 17*16,  	23,  	}, 
	{	 15*16,  	21,  	}, 
	{	 13*16,  	19,   	},  
	{	 11*16,  	17,  	}, 
	{	  9*16,   	15, 	},
	{	  8*16,   	0,   	}, 
	{	  0*16,		0,		},
};

#define AD_MIN_LIMIT    5*16   //截止AD，小于该AD时认为电流为0；
/*----------------------------------------------*
 * 宏定义                                       *
 *----------------------------------------------*/

/*****************************************************************************
函  数 : HDW_Cur_Init()
功  能 : 初始化变量
参  数 : 无
返  回 : 无
其  他 : 无
*****************************************************************************/
void HDW_Cur_Init(void)
{
    U08 i;

    /* 读取校准值 */


    /* 初始化TEMP类型 */


    /* 初始化TEMP变量 */
    for (i=0; i<MAX_CUR_NUM; i++)
    {
//        curr_type[i] = TEST_CURR_TYPE;
        Hdw_Cur[i] = SENSOR_NOEXIST;
    }
}


#if 0
/*******************************************************************************
 函 数: HDW_AdcSampleCur
 功 能: AD采样,10ms中断调用
 参 数: 空
 返 回: 空
 通 道: 计算零点测试通道后，循环切换温度通道；液位与温度通道一起采样
 采 样: 先采样当前通道--连续采样16次并累加，以得到一个样点(注:没有求平均值)，
        然后选择好下次AD转换通道与放大倍数(CD4051)
 初 始 化: AD_GetGnd()结束时，初始化10msAD中断中第一次采样CH_NTC1
*******************************************************************************/
void HDW_AdcSampleCur(void)
{
    U08 cntConti;           /* ad连续采样计数器 */
    U16 adSum_Cur[MAX_CUR_NUM];/* ad连续采样16次累加和 */
    U08 Cur_idx = 0;
    U16 Cur_filt = 0;

    
    MEMCLR(adSum_Cur, sizeof(adSum_Cur));
    for (cntConti=0; cntConti<MAX_AD_CONTI_SAMPLE; cntConti++)
    {
        U16 Ai_Ad[MAX_CUR_NUM];
        MCU_GetAllCurAdCh(Ai_Ad);
        for (Cur_idx=0; Cur_idx<MAX_CUR_NUM; Cur_idx++)
        {
            adSum_Cur[Cur_idx] += Ai_Ad[Cur_idx];
        }
    }

    Cur_filt = CurCell.cnt%MAX_AD_FILTER_NUM;
    for (Cur_idx=0; Cur_idx<MAX_CUR_NUM; Cur_idx++)
    {
        CurCell.adBuf[Cur_idx][Cur_filt] = adSum_Cur[Cur_idx];
    }
    
    if( CurCell.cnt != 0xff) CurCell.cnt++;  
}




/*****************************************************************************
函  数 : HDW_AdToCur()
功  能 : AD转电流
参  数 : I16 ad 	: AD值
		 I16 type	: 电流互感器类型 
返  回 : 无
其  他 : 无
*****************************************************************************/
I16 HDW_AdToCur(U16 ad, I16 type)
{
    I16 cur;
    CURDATA const * pTab;
    U16 k, head, trail;
    I32 x1,x2,y1,y2;

    // 选取电流互感器类型
	switch (type)
	{
		case CURR_25A:
			pTab = TabCUR_25A;
			head = 0;
			trail = ARRAY_ELEMENTS(TabCUR_25A);
			break;
			
		case CURR_50A:
        default:
			pTab = TabCUR_50A;
			head = 0;
			trail = ARRAY_ELEMENTS(TabCUR_50A);
			break;
			
		case CURR_35A:	
			pTab = TabCUR_35A;
			head = 0;
			trail = ARRAY_ELEMENTS(TabCUR_35A);
			break;
	}
    
    if (ad >= pTab[0].AD)       cur = pTab[0].cur;
    else if(ad <= AD_MIN_LIMIT) cur = 0;
    else
    {
        k = (head + trail) >> 1;
        do
        {
            if (ad > pTab[k].AD)             /* 前部 */
            {
                trail = k;      
                k = (head + trail) >> 1;
            }
            else if (ad < pTab[k+1].AD)      /* 后部 */
            {
                head = k + 1;   
                k = (head + trail) >> 1;
            }
            else
            {
                break;
            }
        } while (1);

        x1 = (I32)pTab[k].AD;
        x2 = (I32)pTab[k+1].AD;
        y1 = (I32)pTab[k].cur;
        y2 = (I32)pTab[k+1].cur;

        cur = ((ad-x2)*(y1-y2))/(x1-x2) + y2;/* 原公式 */
//      cur = ((ad-x1)*(y2-y1) + ((x2-x1)>>1))/(x2-x1) + y1;/* 原公式 */
//      cur = (ad*(y2-y1) + y1*x2- y2*x1 + ((x2-x1)>>1))/(x2-x1);/* 通分 */

    }

    return cur;
}


/*****************************************************************************
函  数 : HDW_GetAllCur()
功  能 : 硬件底层读取电流值,在硬件层主调度调用
参  数 : 无
返  回 : 无
其  他 : 无
*****************************************************************************/
void HDW_GetAllCur(void)
{
    U08 i;
    U16 adFilter;           /* AD滤波值 */
    
    if (CurCell.cnt < MAX_AD_FILTER_NUM)
    {
        return;
    }

    CurCell.cnt = 0;
    
    for (i=0; i<MAX_CUR_NUM; i++)	//NOTE-CXW // 按王继松2017-3-13邮件更改
    {
        adFilter = AD_Filter(CurCell.adBuf[i], TRUE);
        TestCurCurAd(i) = adFilter;
        Hdw_Cur[i] = HDW_AdToCur(adFilter, curr_type[i]);
    }
}
#endif

/*****************************************************************************
函  数 : PunpGetCur()
功  能 : 读取电流接口函数
参  数 : I16 CurBuf[] : 电流缓存区
         I16 CurType[]: 电流类型
         U16 CurNum   : 电流个数
返  回 : TRUE成功/FALSE失败
其  他 : 无
*****************************************************************************/
BOL PunpGetCur(I16 CurBuf[], I16 CurType[], U16 CurNum)
{
    U08 i;
    
    if (CurNum > MAX_CUR_NUM)    
        return FALSE;

    for (i=0; i<CurNum; i++)
    {
        CurBuf[i] = Hdw_Cur[i];
//        curr_type[i] = CurType[i];
    }    

    return TRUE;    
}
#endif 
